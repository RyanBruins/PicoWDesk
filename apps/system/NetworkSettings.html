<!doctype html>
<html>
<head>
<meta charset="utf-8"><title>Network Settings</title>
<meta name="window-defaults" content='{"top":50,"left":150,"width":400,"height":550}'>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
body {margin:0; font-family:-apple-system; padding:20px; background:#f7f7f7;}
button, input {margin:5px 0; padding:6px 12px;}
table {border-collapse:collapse; width:100%;}
td, th {padding:6px; border-bottom:1px solid #ddd; text-align:left;}
tr:hover {background:#eef; cursor:pointer;}
.rssi-bar {height:6px; background:#4caf50; border-radius:3px;}
</style>
</head>
<body>
<h2>Network Settings</h2>
<div id="info"></div>
<hr>
<h3>Available Networks</h3>
<button onclick="scanNetworks()">Scan Networks</button>
<table id="nets">
  <thead><tr><th>SSID</th><th>RSSI</th><th></th></tr></thead>
  <tbody></tbody>
</table>
<hr>
<input id="ssid" placeholder="SSID">
<input id="psk" type="password" placeholder="Password">
<button onclick="connect()">Connect to Wi-Fi</button>
<hr>
<!-- Dynamic mode toggle button -->
<button id="modeBtn" onclick="toggleMode()"></button>

<script>
let currentMode = ""; // updated on load

async function load(){
  try {
    const d = await fetch("/api/info").then(r => r.json());
    currentMode = (d.mode || "").toUpperCase();
    console.log("Server mode =", currentMode);

    document.getElementById("info").innerHTML =
      `Current mode: ${d.mode}<br>` +
      `AP IP: ${d.ip_ap || "—"}<br>` +
      `STA IP: ${d.ip_sta || "—"}`;

    await scanNetworks(false); // initial scan without alert
    updateModeButton();
  } catch (e) {
    console.error("Error loading info:", e);
    alert("Failed to load network info from Pico.");
  }
}

function updateModeButton(){
  const btn = document.getElementById("modeBtn");
  if(currentMode === "AP"){
    btn.textContent = "Switch to STA Mode!";
  } else {
    btn.textContent = "Switch to AP-only Mode!";
  }
}

function select(ssid){
  document.getElementById("ssid").value = ssid;
}

async function scanNetworks(showAlert=true){
  try {
    const nets = await fetch("/api/scan").then(r => r.json());
    const tbody = document.querySelector("#nets tbody");
    tbody.innerHTML = "";
    if(!Array.isArray(nets) || nets.length === 0){
      tbody.innerHTML = "<tr><td colspan='3'>No networks found</td></tr>";
      if(showAlert) alert("No networks found.");
      return;
    }
    // Sort by RSSI (strongest first)
    nets.sort((a,b) => b.rssi - a.rssi);
    nets.forEach(net => {
      const tr = document.createElement("tr");
      tr.onclick = () => select(net.ssid);
      const rssiPercent = Math.min(100, Math.max(0, (net.rssi + 100) * 2));
      tr.innerHTML = `
        <td>${net.ssid}</td>
        <td>
          <div class="rssi-bar" style="width:${rssiPercent}%;"></div>
          ${net.rssi} dBm
        </td>
        <td><button onclick="select('${net.ssid}'); event.stopPropagation();">Select</button></td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error("Error scanning networks:", e);
    if(showAlert) alert("Failed to scan networks.");
  }
}

async function connect(){
  const ssid = document.getElementById("ssid").value;
  const psk  = document.getElementById("psk").value;
  if(!ssid){ alert("Enter SSID"); return; }
  try {
    await fetch("/api/connect", {
      method:"POST",
      body:JSON.stringify({ssid, psk})
    });
    alert("Connecting… Pico will restart shortly.");
  } catch(e) {
    console.error("Connect error:", e);
    alert("Failed to send connection request.");
  }
}

async function toggleMode() {
  try {
    if (currentMode === "AP") {
      await fetch("/api/mode/sta", {method: "POST"});
      alert("Switching to STA mode… Pico will restart shortly.");
    } else {
      await fetch("/api/mode/ap", {method: "POST"});
      alert("Switching to AP-only mode… Pico will restart shortly.");
    }
  } catch (e) {
    console.error("Toggle mode error:", e);
    alert("Failed to toggle mode.");
  }
}

load();
</script>
</body>
</html>
